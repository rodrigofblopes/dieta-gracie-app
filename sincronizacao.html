<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Sincroniza√ß√£o - Dieta Gracie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="sync-manager.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow mb-4 sm:mb-6">
            <div class="flex flex-wrap border-b overflow-x-auto">
                <a href="dashboard.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 text-gray-600 hover:text-gray-800 text-sm sm:text-base whitespace-nowrap">
                    üìä Dashboard
                </a>
                <a href="ingredientes.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 text-gray-600 hover:text-gray-800 text-sm sm:text-base whitespace-nowrap">
                    ‚ûï Ingredientes
                </a>
                <a href="refeicoes.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 text-gray-600 hover:text-gray-800 text-sm sm:text-base whitespace-nowrap">
                    üéØ Refei√ß√µes
                </a>
                <a href="receitas.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 text-gray-600 hover:text-gray-800 text-sm sm:text-base whitespace-nowrap">
                    üë®‚Äçüç≥ Receitas
                </a>
                <a href="historico.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 text-gray-600 hover:text-gray-800 text-sm sm:text-base whitespace-nowrap">
                    üìÖ Hist√≥rico
                </a>
                <a href="sincronizacao.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 border-b-2 border-blue-600 text-blue-600 bg-blue-50 text-sm sm:text-base whitespace-nowrap">
                    üîÑ Sincroniza√ß√£o
                </a>
            </div>
        </div>

        <!-- Content -->
        <div class="space-y-4 sm:space-y-6">
            <!-- Header da P√°gina -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 sm:p-6 rounded-lg">
                <h2 class="text-xl sm:text-2xl font-bold mb-2">üîÑ Sincroniza√ß√£o de Dados</h2>
                <p class="text-blue-100 text-sm sm:text-base">Gerencie seus dados entre computador e celular</p>
            </div>

            <!-- Status da Conex√£o -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow">
                <h3 class="text-lg sm:text-xl font-semibold mb-4">üì° Status da Conex√£o</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <div class="flex items-center gap-2 mb-2">
                            <span id="status-icon" class="text-2xl">üåê</span>
                            <span class="font-semibold text-green-800">Status</span>
                        </div>
                        <p id="status-text" class="text-green-700 text-sm">Conectado</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">üíæ</span>
                            <span class="font-semibold text-blue-800">Tamanho dos Dados</span>
                        </div>
                        <p id="data-size" class="text-blue-700 text-sm">0 KB</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">üìÖ</span>
                            <span class="font-semibold text-purple-800">√öltimo Backup</span>
                        </div>
                        <p id="last-backup" class="text-purple-700 text-sm">Nunca</p>
                    </div>
                </div>
            </div>

            <!-- Exportar Dados -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow">
                <h3 class="text-lg sm:text-xl font-semibold mb-4">üì§ Exportar Dados</h3>
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                    <h4 class="font-semibold text-blue-800 mb-2">üí° Como usar:</h4>
                    <ol class="text-blue-700 text-sm space-y-1">
                        <li>1. Clique em "Exportar Backup" para baixar seus dados</li>
                        <li>2. Envie o arquivo para seu celular (WhatsApp, email, etc.)</li>
                        <li>3. No celular, clique em "Importar Backup" e selecione o arquivo</li>
                        <li>4. Seus dados estar√£o sincronizados!</li>
                    </ol>
                </div>
                <button onclick="exportarDados()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    üì§ Exportar Backup
                </button>
            </div>

            <!-- Importar Dados -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow">
                <h3 class="text-lg sm:text-xl font-semibold mb-4">üì• Importar Dados</h3>
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4">
                    <h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Aten√ß√£o:</h4>
                    <p class="text-yellow-700 text-sm">Importar dados ir√° substituir todos os dados atuais. Fa√ßa um backup antes se necess√°rio.</p>
                </div>
                <div class="flex items-center gap-4">
                    <input type="file" id="import-file" accept=".json" class="hidden" onchange="importarDados(this)">
                    <button onclick="document.getElementById('import-file').click()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        üì• Selecionar Arquivo
                    </button>
                    <span id="selected-file" class="text-gray-600 text-sm">Nenhum arquivo selecionado</span>
                </div>
            </div>

            <!-- Sincroniza√ß√£o na Nuvem -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow">
                <h3 class="text-lg sm:text-xl font-semibold mb-4">‚òÅÔ∏è Sincroniza√ß√£o na Nuvem</h3>
                <p class="text-gray-600 mb-4">Sincronize seus dados automaticamente entre computador e celular usando a nuvem.</p>
                
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <button onclick="salvarNaNuvem()" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">‚òÅÔ∏è</div>
                        <div class="font-semibold">Salvar na Nuvem</div>
                        <div class="text-sm opacity-90">Enviar dados para a nuvem</div>
                    </button>

                    <button onclick="carregarDaNuvem()" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">‚¨áÔ∏è</div>
                        <div class="font-semibold">Carregar da Nuvem</div>
                        <div class="text-sm opacity-90">Baixar dados da nuvem</div>
                    </button>

                    <button onclick="sincronizacaoAutomatica()" class="bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">üîÑ</div>
                        <div class="font-semibold">Sincroniza√ß√£o Autom√°tica</div>
                        <div class="text-sm opacity-90">Sincronizar automaticamente</div>
                    </button>
                </div>

                <!-- Sincroniza√ß√£o em Tempo Real -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-green-800 mb-2">‚ö° Sincroniza√ß√£o em Tempo Real</h4>
                    <p class="text-green-700 text-sm mb-3">Sincroniza√ß√£o autom√°tica a cada 10 segundos entre PC e celular.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button onclick="iniciarTempoReal()" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg text-center">
                            <div class="text-xl mb-1">üöÄ</div>
                            <div class="font-semibold">Iniciar Tempo Real</div>
                            <div class="text-sm opacity-90">Sincroniza√ß√£o autom√°tica</div>
                        </button>
                        <button onclick="pararTempoReal()" class="bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg text-center">
                            <div class="text-xl mb-1">‚èπÔ∏è</div>
                            <div class="font-semibold">Parar Tempo Real</div>
                            <div class="text-sm opacity-90">Parar sincroniza√ß√£o</div>
                        </button>
                    </div>
                </div>

                <!-- Bot√µes de Debug -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <button onclick="forcarSincronizacao()" class="bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-lg text-center">
                        <div class="text-xl mb-1">‚ö°</div>
                        <div class="font-semibold">For√ßar Sincroniza√ß√£o</div>
                        <div class="text-sm opacity-90">Sincronizar manualmente</div>
                    </button>

                    <button onclick="verificarStatus()" class="bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg text-center">
                        <div class="text-xl mb-1">üîç</div>
                        <div class="font-semibold">Verificar Status</div>
                        <div class="text-sm opacity-90">Ver dados locais e na nuvem</div>
                    </button>
                </div>

                <!-- Bot√£o de Sincroniza√ß√£o Inicial -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-yellow-800 mb-2">üöÄ Sincroniza√ß√£o Inicial</h4>
                    <p class="text-yellow-700 text-sm mb-3">Use este bot√£o se os dados n√£o aparecerem automaticamente no celular.</p>
                    <button onclick="sincronizacaoInicial()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-3 rounded-lg text-center w-full">
                        <div class="text-xl mb-1">üîÑ</div>
                        <div class="font-semibold">Sincroniza√ß√£o Inicial</div>
                        <div class="text-sm opacity-90">For√ßar carregamento inicial</div>
                    </button>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-2">‚ÑπÔ∏è Como funciona:</h4>
                    <ul class="text-blue-700 text-sm space-y-1">
                        <li>‚Ä¢ <strong>Salvar na Nuvem:</strong> Envia seus dados para a nuvem</li>
                        <li>‚Ä¢ <strong>Carregar da Nuvem:</strong> Baixa dados da nuvem para este dispositivo</li>
                        <li>‚Ä¢ <strong>Sincroniza√ß√£o Autom√°tica:</strong> Sincroniza automaticamente quando h√° conex√£o</li>
                        <li>‚Ä¢ <strong>Modo Offline:</strong> Funciona mesmo sem internet</li>
                    </ul>
                </div>
            </div>

            <!-- Estat√≠sticas -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow">
                <h3 class="text-lg sm:text-xl font-semibold mb-4">üìä Estat√≠sticas dos Dados</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold" id="total-ingredientes">0</div>
                        <div class="text-sm">Ingredientes</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold" id="total-refeicoes">0</div>
                        <div class="text-sm">Refei√ß√µes</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-400 to-purple-600 text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold" id="dias-ativos">0</div>
                        <div class="text-sm">Dias Ativos</div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-400 to-orange-600 text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold" id="ultima-atualizacao">Hoje</div>
                        <div class="text-sm">√öltima Atualiza√ß√£o</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBE5_S3-lBa44RVNtEYunkB0Ik999KInI8",
            authDomain: "dieta-gracie-app.firebaseapp.com",
            projectId: "dieta-gracie-app",
            storageBucket: "dieta-gracie-app.firebasestorage.app",
            messagingSenderId: "191357835216",
            appId: "1:191357835216:web:9d71f6a529e04ef6b2cbd5",
            measurementId: "G-QHGB6EYJC0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // CloudSync class
        class CloudSync {
            constructor() {
                this.userId = this.getUserId();
                this.isOnline = navigator.onLine;
                console.log('üöÄ CloudSync inicializado para usu√°rio:', this.userId);
                console.log('üåê Status online:', this.isOnline);
                
                this.setupOfflineSupport();
                this.setupAutoSync();
                
                // Carregar dados automaticamente ao iniciar
                this.autoLoad().then(loaded => {
                    if (loaded) {
                        this.showNotification('‚òÅÔ∏è Dados sincronizados automaticamente!', 'success');
                    } else {
                        console.log('‚ÑπÔ∏è Nenhum dado carregado automaticamente');
                    }
                });

                // Iniciar sincroniza√ß√£o em tempo real ap√≥s 5 segundos
                setTimeout(() => {
                    this.startRealTimeSync();
                }, 5000);
            }

            // Gerar ID √∫nico do usu√°rio (fixo para sincroniza√ß√£o)
            getUserId() {
                let userId = localStorage.getItem('userId');
                if (!userId) {
                    userId = 'dieta_gracie_user_2025';
                    localStorage.setItem('userId', userId);
                }
                return userId;
            }

            // Configurar suporte offline
            setupOfflineSupport() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showNotification('üåê Conectado √† internet - Sincronizando...', 'success');
                    this.syncData();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showNotification('üì± Modo offline - Dados salvos localmente', 'info');
                });
            }

            // Salvar dados na nuvem
            async saveToCloud(data) {
                try {
                    if (!this.isOnline) {
                        this.saveForLaterSync(data);
                        return false;
                    }

                    console.log('üíæ Salvando dados na nuvem para usu√°rio:', this.userId);
                    console.log('üìä Dados a serem salvos:', data);
                    
                    await setDoc(doc(db, 'users', this.userId), {
                        dadosNutricionais: data,
                        lastUpdate: serverTimestamp(),
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            timestamp: new Date().toISOString()
                        }
                    });

                    console.log('‚úÖ Dados salvos com sucesso na nuvem');
                    this.showNotification('‚òÅÔ∏è Dados salvos na nuvem!', 'success');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao salvar na nuvem:', error);
                    this.saveForLaterSync(data);
                    this.showNotification('‚ùå Erro ao salvar na nuvem - Salvando localmente', 'error');
                    return false;
                }
            }

            // Carregar dados da nuvem
            async loadFromCloud() {
                try {
                    if (!this.isOnline) {
                        this.showNotification('üì± Modo offline - Carregando dados locais', 'info');
                        return null;
                    }

                    console.log('üîç Buscando dados para usu√°rio:', this.userId);
                    const docRef = doc(db, 'users', this.userId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        console.log('üìÑ Documento encontrado:', data);
                        this.showNotification('‚òÅÔ∏è Dados carregados da nuvem!', 'success');
                        return data.dadosNutricionais;
                    } else {
                        console.log('üìù Documento n√£o encontrado para usu√°rio:', this.userId);
                        this.showNotification('üìù Nenhum dado encontrado na nuvem', 'info');
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar da nuvem:', error);
                    this.showNotification('‚ùå Erro ao carregar da nuvem', 'error');
                    return null;
                }
            }

            // Salvar para sincroniza√ß√£o posterior
            saveForLaterSync(data) {
                const pendingSync = JSON.parse(localStorage.getItem('pendingSync') || '[]');
                pendingSync.push({
                    data: data,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('pendingSync', JSON.stringify(pendingSync));
            }

            // Sincronizar dados pendentes
            async syncData() {
                if (!this.isOnline) return;

                const pendingSync = JSON.parse(localStorage.getItem('pendingSync') || '[]');
                if (pendingSync.length === 0) return;

                for (const sync of pendingSync) {
                    try {
                        await this.saveToCloud(sync.data);
                    } catch (error) {
                        console.error('Erro na sincroniza√ß√£o pendente:', error);
                    }
                }

                localStorage.removeItem('pendingSync');
                this.showNotification('üîÑ Sincroniza√ß√£o pendente conclu√≠da!', 'success');
            }

            // Sincroniza√ß√£o autom√°tica
            async autoSync() {
                const localData = localStorage.getItem('dadosNutricionais');
                if (localData) {
                    await this.saveToCloud(JSON.parse(localData));
                }
            }

            // Sincroniza√ß√£o em tempo real
            async realTimeSync() {
                if (!this.isOnline) return;
                
                try {
                    // Salvar dados locais na nuvem
                    const localData = localStorage.getItem('dadosNutricionais');
                    if (localData) {
                        await this.saveToCloud(JSON.parse(localData));
                    }
                    
                    // Carregar dados da nuvem
                    await this.autoLoad();
                    
                    console.log('‚úÖ Sincroniza√ß√£o em tempo real conclu√≠da');
                } catch (error) {
                    console.error('‚ùå Erro na sincroniza√ß√£o em tempo real:', error);
                }
            }

            // Iniciar sincroniza√ß√£o em tempo real
            startRealTimeSync() {
                // Sincronizar a cada 10 segundos
                this.realTimeInterval = setInterval(() => {
                    this.realTimeSync();
                }, 10000);
                
                console.log('üöÄ Sincroniza√ß√£o em tempo real iniciada');
            }

            // Parar sincroniza√ß√£o em tempo real
            stopRealTimeSync() {
                if (this.realTimeInterval) {
                    clearInterval(this.realTimeInterval);
                    this.realTimeInterval = null;
                    console.log('‚èπÔ∏è Sincroniza√ß√£o em tempo real parada');
                }
            }

            // Sincroniza√ß√£o autom√°tica quando dados mudam
            setupAutoSync() {
                // Monitorar mudan√ßas no localStorage
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = function(key, value) {
                    originalSetItem.apply(this, arguments);
                    
                    // Se dados nutricionais mudaram, sincronizar automaticamente
                    if (key === 'dadosNutricionais' && window.cloudSync) {
                        console.log('üîÑ Dados nutricionais alterados, sincronizando...');
                        setTimeout(() => {
                            window.cloudSync.saveToCloud(JSON.parse(value));
                        }, 1000);
                    }
                };

                // Sincroniza√ß√£o autom√°tica a cada 30 segundos
                setInterval(() => {
                    if (this.isOnline) {
                        this.autoSync();
                    }
                }, 30000);

                // Sincroniza√ß√£o quando a p√°gina ganha foco
                window.addEventListener('focus', () => {
                    if (this.isOnline) {
                        console.log('üîÑ P√°gina ganhou foco, sincronizando...');
                        this.autoLoad();
                    }
                });

                // Sincroniza√ß√£o quando volta online
                window.addEventListener('online', () => {
                    console.log('üîÑ Conex√£o restaurada, sincronizando...');
                    this.autoSync();
                });
            }

            // For√ßar sincroniza√ß√£o manual
            async forceSync() {
                console.log('üîÑ For√ßando sincroniza√ß√£o...');
                const localData = localStorage.getItem('dadosNutricionais');
                if (localData) {
                    const success = await this.saveToCloud(JSON.parse(localData));
                    if (success) {
                        this.showNotification('‚úÖ Sincroniza√ß√£o for√ßada conclu√≠da!', 'success');
                    }
                }
            }

            // Verificar status da sincroniza√ß√£o
            async checkSyncStatus() {
                const localData = localStorage.getItem('dadosNutricionais');
                const cloudData = await this.loadFromCloud();
                
                console.log('üìä Status da sincroniza√ß√£o:');
                console.log('Local:', localData ? JSON.parse(localData) : 'vazio');
                console.log('Cloud:', cloudData);
                
                return {
                    local: localData ? JSON.parse(localData) : null,
                    cloud: cloudData,
                    isOnline: this.isOnline
                };
            }

            // Carregar dados automaticamente ao iniciar
            async autoLoad() {
                if (this.isOnline) {
                    console.log('üîÑ Tentando carregar dados da nuvem...');
                    const cloudData = await this.loadFromCloud();
                    if (cloudData) {
                        console.log('‚úÖ Dados encontrados na nuvem:', cloudData);
                        
                        // Verificar se os dados locais s√£o mais recentes
                        const localData = localStorage.getItem('dadosNutricionais');
                        if (localData) {
                            const localObj = JSON.parse(localData);
                            const cloudObj = cloudData;
                            
                            // Mesclar dados de forma inteligente
                            const dadosMesclados = this.mergeData(localObj, cloudObj);
                            localStorage.setItem('dadosNutricionais', JSON.stringify(dadosMesclados));
                            console.log('‚úÖ Dados mesclados e salvos localmente');
                        } else {
                            localStorage.setItem('dadosNutricionais', JSON.stringify(cloudData));
                            console.log('‚úÖ Dados da nuvem salvos localmente');
                        }
                        return true;
                    } else {
                        console.log('‚ùå Nenhum dado encontrado na nuvem');
                    }
                } else {
                    console.log('‚ùå Offline - n√£o √© poss√≠vel carregar da nuvem');
                }
                return false;
            }

            // Mesclar dados de forma inteligente
            mergeData(localData, cloudData) {
                const merged = { ...localData };
                
                // Para cada data, mesclar as refei√ß√µes
                Object.keys(cloudData).forEach(data => {
                    if (!merged[data]) {
                        merged[data] = cloudData[data];
                    } else {
                        // Mesclar refei√ß√µes da mesma data
                        const localRefeicoes = merged[data];
                        const cloudRefeicoes = cloudData[data];
                        
                        // Criar mapa de refei√ß√µes por ID para evitar duplicatas
                        const refeicoesMap = new Map();
                        
                        // Adicionar refei√ß√µes locais
                        localRefeicoes.forEach(refeicao => {
                            refeicoesMap.set(refeicao.id, refeicao);
                        });
                        
                        // Adicionar refei√ß√µes da nuvem (sobrescrevem se mesmo ID)
                        cloudRefeicoes.forEach(refeicao => {
                            refeicoesMap.set(refeicao.id, refeicao);
                        });
                        
                        merged[data] = Array.from(refeicoesMap.values());
                    }
                });
                
                return merged;
            }

            // Mostrar notifica√ß√£o
            showNotification(message, type = 'info') {
                // Remover notifica√ß√£o anterior se existir
                const notificacaoAnterior = document.getElementById('cloud-notification');
                if (notificacaoAnterior) {
                    notificacaoAnterior.remove();
                }
                
                // Criar nova notifica√ß√£o
                const notificacao = document.createElement('div');
                notificacao.id = 'cloud-notification';
                notificacao.className = `fixed top-4 left-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${
                    type === 'success' ? 'bg-green-500 text-white' : 
                    type === 'error' ? 'bg-red-500 text-white' : 
                    'bg-blue-500 text-white'
                }`;
                notificacao.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notificacao);
                
                // Remover ap√≥s 3 segundos
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.remove();
                    }
                }, 3000);
            }

            // Obter status da conex√£o
            getConnectionStatus() {
                return {
                    online: this.isOnline,
                    userId: this.userId,
                    pendingSync: JSON.parse(localStorage.getItem('pendingSync') || '[]').length
                };
            }
        }

        // Inst√¢ncia global
        window.cloudSync = new CloudSync();
    </script>
    <script>
        let syncManager;

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            syncManager = new SyncManager();
            atualizarStatus();
            atualizarEstatisticas();
            
            // Atualizar a cada 30 segundos
            setInterval(atualizarStatus, 30000);
        });

        // Exportar dados
        function exportarDados() {
            syncManager.exportAllData();
            localStorage.setItem('lastBackup', new Date().toISOString());
            atualizarStatus();
        }

        // Importar dados
        function importarDados(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('selected-file').textContent = file.name;
                syncManager.importData(file);
                localStorage.setItem('lastBackup', new Date().toISOString());
                setTimeout(() => {
                    atualizarStatus();
                    atualizarEstatisticas();
                }, 1000);
            }
        }

        // Sincronizar com nuvem (simulado)
        function sincronizarNuvem() {
            syncManager.syncWithGoogleDrive();
        }

        // Fun√ß√µes para sincroniza√ß√£o na nuvem
        async function salvarNaNuvem() {
            const dados = localStorage.getItem('dadosNutricionais');
            if (dados) {
                const success = await window.cloudSync.saveToCloud(JSON.parse(dados));
                if (success) {
                    syncManager.showNotification('‚òÅÔ∏è Dados salvos na nuvem com sucesso!', 'success');
                }
            } else {
                syncManager.showNotification('‚ùå Nenhum dado para salvar', 'error');
            }
        }

        async function carregarDaNuvem() {
            const dados = await window.cloudSync.loadFromCloud();
            if (dados) {
                localStorage.setItem('dadosNutricionais', JSON.stringify(dados));
                syncManager.showNotification('‚òÅÔ∏è Dados carregados da nuvem!', 'success');
                // Recarregar a p√°gina para atualizar os dados
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }

        async function sincronizacaoAutomatica() {
    await window.cloudSync.autoSync();
    syncManager.showNotification('üîÑ Sincroniza√ß√£o autom√°tica conclu√≠da!', 'success');
}

async function forcarSincronizacao() {
    await window.cloudSync.forceSync();
}

async function verificarStatus() {
    const status = await window.cloudSync.checkSyncStatus();
    console.log('Status da sincroniza√ß√£o:', status);
    
    let mensagem = 'üìä Status da Sincroniza√ß√£o:\n';
    mensagem += `üåê Online: ${status.isOnline ? 'Sim' : 'N√£o'}\n`;
    mensagem += `üÜî Usu√°rio: ${window.cloudSync.userId}\n`;
    mensagem += `üíæ Dados locais: ${status.local ? 'Presentes' : 'Vazios'}\n`;
    mensagem += `‚òÅÔ∏è Dados na nuvem: ${status.cloud ? 'Presentes' : 'Vazios'}`;
    
    if (status.local) {
        const localKeys = Object.keys(status.local);
        mensagem += `\nüìÖ Datas locais: ${localKeys.length > 0 ? localKeys.join(', ') : 'Nenhuma'}`;
    }
    
    if (status.cloud) {
        const cloudKeys = Object.keys(status.cloud);
        mensagem += `\n‚òÅÔ∏è Datas na nuvem: ${cloudKeys.length > 0 ? cloudKeys.join(', ') : 'Nenhuma'}`;
    }
    
    alert(mensagem);
}

async function iniciarTempoReal() {
    window.cloudSync.startRealTimeSync();
    syncManager.showNotification('üöÄ Sincroniza√ß√£o em tempo real iniciada!', 'success');
}

async function pararTempoReal() {
    window.cloudSync.stopRealTimeSync();
    syncManager.showNotification('‚èπÔ∏è Sincroniza√ß√£o em tempo real parada!', 'info');
}

async function sincronizacaoInicial() {
    try {
        syncManager.showNotification('üîÑ Iniciando sincroniza√ß√£o inicial...', 'info');
        
        // For√ßar carregamento da nuvem
        const loaded = await window.cloudSync.autoLoad();
        
        if (loaded) {
            syncManager.showNotification('‚úÖ Sincroniza√ß√£o inicial conclu√≠da! Dados carregados.', 'success');
            // Recarregar a p√°gina para mostrar os dados
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            syncManager.showNotification('‚ùå Nenhum dado encontrado na nuvem. Salve dados primeiro no computador.', 'error');
        }
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o inicial:', error);
        syncManager.showNotification('‚ùå Erro na sincroniza√ß√£o inicial', 'error');
    }
}

        // Atualizar status
        function atualizarStatus() {
            const status = syncManager.getConnectionStatus();
            
            // Status da conex√£o
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');
            
            if (status.online) {
                statusIcon.textContent = 'üåê';
                statusText.textContent = 'Conectado';
            } else {
                statusIcon.textContent = 'üì±';
                statusText.textContent = 'Offline';
            }
            
            // Tamanho dos dados
            document.getElementById('data-size').textContent = status.dataSize;
            
            // √öltimo backup
            const lastBackup = status.lastBackup;
            if (lastBackup) {
                const date = new Date(lastBackup);
                document.getElementById('last-backup').textContent = date.toLocaleDateString('pt-BR');
            } else {
                document.getElementById('last-backup').textContent = 'Nunca';
            }
        }

        // Atualizar estat√≠sticas
        function atualizarEstatisticas() {
            // Total de ingredientes
            const ingredientes = JSON.parse(localStorage.getItem('ingredientes') || '[]');
            document.getElementById('total-ingredientes').textContent = ingredientes.length;
            
            // Total de refei√ß√µes
            const dadosNutricionais = JSON.parse(localStorage.getItem('dadosNutricionais') || '{}');
            const totalRefeicoes = Object.values(dadosNutricionais).reduce((total, refeicoes) => total + refeicoes.length, 0);
            document.getElementById('total-refeicoes').textContent = totalRefeicoes;
            
            // Dias ativos
            const diasAtivos = Object.keys(dadosNutricionais).length;
            document.getElementById('dias-ativos').textContent = diasAtivos;
            
            // √öltima atualiza√ß√£o
            const hoje = new Date().toLocaleDateString('pt-BR');
            document.getElementById('ultima-atualizacao').textContent = hoje;
        }
    </script>
</body>
</html>
