<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Refei√ß√µes - Dieta Gracie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBE5_S3-lBa44RVNtEYunkB0Ik999KInI8",
            authDomain: "dieta-gracie-app.firebaseapp.com",
            projectId: "dieta-gracie-app",
            storageBucket: "dieta-gracie-app.firebasestorage.app",
            messagingSenderId: "191357835216",
            appId: "1:191357835216:web:9d71f6a529e04ef6b2cbd5",
            measurementId: "G-QHGB6EYJC0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // CloudSync class (vers√£o simplificada para refeicoes.html)
        class CloudSync {
            constructor() {
                this.userId = this.getUserId();
                this.isOnline = navigator.onLine;
                console.log('üöÄ CloudSync inicializado para usu√°rio:', this.userId);
            }

            getUserId() {
                let userId = localStorage.getItem('userId');
                if (!userId) {
                    userId = 'dieta_gracie_user_2025';
                    localStorage.setItem('userId', userId);
                }
                return userId;
            }

            async saveToCloud(data) {
                try {
                    if (!this.isOnline) return false;

                    await setDoc(doc(db, 'users', this.userId), {
                        dadosNutricionais: data,
                        lastUpdate: serverTimestamp(),
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            timestamp: new Date().toISOString()
                        }
                    });

                    console.log('‚úÖ Dados salvos na nuvem');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao salvar na nuvem:', error);
                    return false;
                }
            }
        }

        // Inst√¢ncia global
        window.cloudSync = new CloudSync();
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow mb-4 sm:mb-6">
            <div class="flex flex-wrap border-b overflow-x-auto">
                <a href="dashboard.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 text-gray-600 hover:text-gray-800 text-sm sm:text-base whitespace-nowrap">
                    üìä Dashboard
                </a>
                <a href="ingredientes.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 text-gray-600 hover:text-gray-800 text-sm sm:text-base whitespace-nowrap">
                    ‚ûï Ingredientes
                </a>
                <a href="refeicoes.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 border-b-2 border-blue-600 text-blue-600 bg-blue-50 text-sm sm:text-base whitespace-nowrap">
                    üéØ Refei√ß√µes
                </a>
                <a href="receitas.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 text-gray-600 hover:text-gray-800 text-sm sm:text-base whitespace-nowrap">
                    üë®‚Äçüç≥ Receitas
                </a>
                <a href="historico.html" class="px-3 sm:px-6 py-3 sm:py-4 flex items-center gap-1 sm:gap-2 text-gray-600 hover:text-gray-800 text-sm sm:text-base whitespace-nowrap">
                    üìÖ Hist√≥rico
                </a>
            </div>
        </div>

        <!-- Content -->
        <div class="space-y-4 sm:space-y-6">
            <!-- Construir Refei√ß√£o -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow">
                <h3 class="text-base sm:text-lg font-semibold mb-4">üçΩÔ∏è Construir Refei√ß√£o</h3>
                
                <!-- Informa√ß√µes da Refei√ß√£o -->
                <div class="bg-blue-50 p-3 sm:p-4 rounded-lg mb-4 sm:mb-6">
                    <h4 class="font-semibold text-blue-800 mb-2 text-sm sm:text-base">üìÖ Informa√ß√µes da Refei√ß√£o</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-1">Data:</label>
                            <input
                                type="date"
                                id="data-refeicao"
                                class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm"
                                value=""
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-1">Hor√°rio:</label>
                            <input
                                type="time"
                                id="horario-refeicao"
                                class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm"
                                value=""
                            />
                        </div>
                    </div>
                </div>
                
                <!-- Refei√ß√£o Atual -->
                <div id="refeicao-atual" class="mb-4 sm:mb-6 p-3 sm:p-4 bg-green-50 rounded-lg border border-green-200" style="display: none;">
                    <h4 class="font-semibold mb-3 text-green-800">ü•ó Refei√ß√£o Atual:</h4>
                    <div id="itens-refeicao" class="space-y-2">
                        <!-- Itens ser√£o inseridos aqui -->
                    </div>
                    
                    <!-- Resumo Nutricional -->
                    <div class="mt-4 p-3 bg-white rounded border">
                        <h5 class="font-semibold mb-2 text-sm">üìä Resumo Nutricional:</h5>
                        <div id="resumo-nutricional" class="grid grid-cols-2 sm:grid-cols-5 gap-2 text-xs sm:text-sm">
                            <!-- Resumo ser√° calculado aqui -->
                        </div>
                    </div>
                    
                    <button
                        onclick="salvarRefeicao()"
                        class="mt-4 bg-green-600 text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2 text-sm sm:text-base"
                    >
                        üíæ Salvar Refei√ß√£o
                    </button>
                </div>

                <!-- Grid de Ingredientes -->
                <div id="grid-ingredientes" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                    <!-- Ingredientes ser√£o inseridos aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados padr√£o dos ingredientes (baseados no Insumos.csv)
        const ingredientesPadrao = [
            { id: 1, name: 'Peito de Frango', category: 'Prote√≠na', calories: 165, protein: 31, carbs: 0, fat: 3.6, fiber: 0 },
            { id: 2, name: 'F√≠gado Bovino', category: 'Prote√≠na', calories: 135, protein: 20, carbs: 3.9, fat: 3.6, fiber: 0 },
            { id: 3, name: 'Contra-Fil√©', category: 'Prote√≠na', calories: 250, protein: 26, carbs: 0, fat: 15, fiber: 0 },
            { id: 4, name: 'Quinoa Gr√£o Mix', category: 'Carboidrato', calories: 120, protein: 4.4, carbs: 21.3, fat: 1.9, fiber: 2.8 },
            { id: 5, name: 'Aveia em Flocos', category: 'Carboidrato', calories: 389, protein: 16.9, carbs: 66, fat: 6.9, fiber: 10.6 },
            { id: 6, name: 'Farelo de Aveia', category: 'Carboidrato', calories: 246, protein: 17.3, carbs: 66, fat: 7, fiber: 15.4 },
            { id: 7, name: 'Nozes', category: 'Gordura', calories: 654, protein: 15, carbs: 14, fat: 65, fiber: 6.7 },
            { id: 8, name: 'Amendoim Torrado', category: 'Gordura', calories: 567, protein: 25.8, carbs: 16, fat: 49, fiber: 8.5 },
            { id: 9, name: 'Farinha de Aveia', category: 'Carboidrato', calories: 389, protein: 16.9, carbs: 66, fat: 6.9, fiber: 10.6 },
            { id: 10, name: 'Quinoa Urbano', category: 'Carboidrato', calories: 120, protein: 4.4, carbs: 21.3, fat: 1.9, fiber: 2.8 },
            { id: 11, name: 'Ovos', category: 'Prote√≠na', calories: 155, protein: 13, carbs: 1.1, fat: 11, fiber: 0 },
            { id: 12, name: 'Castanha do Par√°', category: 'Gordura', calories: 656, protein: 14, carbs: 12, fat: 66, fiber: 7.5 },
            { id: 13, name: 'Amendoim Cru', category: 'Gordura', calories: 567, protein: 25.8, carbs: 16, fat: 49, fiber: 8.5 },
            { id: 14, name: 'Sardinha', category: 'Prote√≠na', calories: 208, protein: 24, carbs: 0, fat: 12, fiber: 0 },
            { id: 15, name: 'Atum', category: 'Prote√≠na', calories: 144, protein: 30, carbs: 0, fat: 1, fiber: 0 },
            { id: 16, name: 'Batata Doce', category: 'Carboidrato', calories: 86, protein: 1.6, carbs: 20, fat: 0.1, fiber: 3 },
            { id: 17, name: 'Batata Doce Roxa', category: 'Carboidrato', calories: 86, protein: 1.6, carbs: 20, fat: 0.1, fiber: 3 },
            { id: 18, name: 'Cenoura', category: 'Vegetal', calories: 41, protein: 0.9, carbs: 10, fat: 0.2, fiber: 2.8 },
            { id: 19, name: 'Abacate', category: 'Gordura', calories: 160, protein: 2, carbs: 8.5, fat: 15, fiber: 6.7 },
            { id: 20, name: 'Br√≥colis', category: 'Vegetal', calories: 34, protein: 2.8, carbs: 7, fat: 0.4, fiber: 2.6 },
            { id: 21, name: 'Couve Flor', category: 'Vegetal', calories: 25, protein: 1.9, carbs: 5, fat: 0.3, fiber: 2 },
            { id: 22, name: 'A√ßa√≠', category: 'Fruta', calories: 70, protein: 4, carbs: 4, fat: 5, fiber: 2.5 },
            { id: 23, name: 'Arroz Branco', category: 'Carboidrato', calories: 130, protein: 2.7, carbs: 28, fat: 0.3, fiber: 0.4 },
            { id: 24, name: 'Banana', category: 'Fruta', calories: 89, protein: 1.1, carbs: 23, fat: 0.3, fiber: 2.6 }
        ];

        // Carregar ingredientes
        function carregarIngredientes() {
            const ingredientes = JSON.parse(localStorage.getItem('ingredientes') || JSON.stringify(ingredientesPadrao));
            return ingredientes;
        }

        // Obter classe CSS para categoria
        function getCategoriaClass(categoria) {
            const classes = {
                'Prote√≠na': 'bg-red-100 text-red-700',
                'Carboidrato': 'bg-green-100 text-green-700',
                'Gordura': 'bg-yellow-100 text-yellow-700',
                'Fruta': 'bg-orange-100 text-orange-700',
                'Vegetal': 'bg-green-100 text-green-700',
                'L√≠quido': 'bg-blue-100 text-blue-700'
            };
            return classes[categoria] || 'bg-gray-100 text-gray-700';
        }

        // Renderizar grid de ingredientes
        function renderizarIngredientes() {
            const ingredientes = carregarIngredientes();
            const grid = document.getElementById('grid-ingredientes');
            
            grid.innerHTML = ingredientes.map(ingrediente => `
                <div class="border rounded-lg p-3 sm:p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-sm sm:text-base">${ingrediente.name}</h4>
                        <span class="px-1 sm:px-2 py-1 rounded-full text-xs ${getCategoriaClass(ingrediente.category)}">
                            ${ingrediente.category}
                        </span>
                    </div>
                    <div class="text-xs sm:text-sm text-gray-600 mb-3">
                        ${ingrediente.calories} kcal ‚Ä¢ ${ingrediente.protein}g prot
                    </div>
                    <button
                        onclick="adicionarARefeicao(${ingrediente.id})"
                        class="w-full bg-blue-600 text-white px-2 sm:px-3 py-2 rounded hover:bg-blue-700 text-xs sm:text-sm"
                    >
                        ‚ûï Adicionar (100g)
                    </button>
                </div>
            `).join('');
        }

        // Adicionar ingrediente √† refei√ß√£o atual
        function adicionarARefeicao(ingredienteId) {
            const ingredientes = carregarIngredientes();
            const ingrediente = ingredientes.find(i => i.id === ingredienteId);
            
            if (ingrediente) {
                const refeicaoAtual = JSON.parse(localStorage.getItem('refeicaoAtual') || '[]');
                
                // Verificar se j√° existe
                const existingIndex = refeicaoAtual.findIndex(item => item.ingrediente.id === ingredienteId);
                
                if (existingIndex >= 0) {
                    refeicaoAtual[existingIndex].quantidade += 100;
                } else {
                    refeicaoAtual.push({
                        ingrediente: ingrediente,
                        quantidade: 100
                    });
                }
                
                localStorage.setItem('refeicaoAtual', JSON.stringify(refeicaoAtual));
                atualizarRefeicaoAtual();
            }
        }

        // Atualizar visualiza√ß√£o da refei√ß√£o atual
        function atualizarRefeicaoAtual() {
            const refeicaoAtual = JSON.parse(localStorage.getItem('refeicaoAtual') || '[]');
            const container = document.getElementById('refeicao-atual');
            const itensContainer = document.getElementById('itens-refeicao');
            
            if (refeicaoAtual.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // Renderizar itens
            itensContainer.innerHTML = refeicaoAtual.map((item, index) => `
                <div class="flex items-center justify-between py-2 border-b last:border-b-0">
                    <span class="text-sm sm:text-base">${item.ingrediente.name}</span>
                    <div class="flex items-center gap-2">
                        <input
                            type="number"
                            value="${item.quantidade}"
                            onchange="atualizarQuantidade(${index}, this.value)"
                            class="w-16 sm:w-20 px-2 py-1 border rounded text-center text-xs sm:text-sm"
                        />
                        <span class="text-xs sm:text-sm text-gray-500">g</span>
                        <button
                            onclick="removerItem(${index})"
                            class="text-red-500 hover:text-red-700 text-sm"
                        >
                            ‚ùå
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Calcular e mostrar resumo nutricional
            calcularResumoNutricional(refeicaoAtual);
        }

        // Atualizar quantidade de um item
        function atualizarQuantidade(index, novaQuantidade) {
            const refeicaoAtual = JSON.parse(localStorage.getItem('refeicaoAtual') || '[]');
            refeicaoAtual[index].quantidade = parseFloat(novaQuantidade) || 0;
            localStorage.setItem('refeicaoAtual', JSON.stringify(refeicaoAtual));
            atualizarRefeicaoAtual();
        }

        // Remover item da refei√ß√£o
        function removerItem(index) {
            const refeicaoAtual = JSON.parse(localStorage.getItem('refeicaoAtual') || '[]');
            refeicaoAtual.splice(index, 1);
            localStorage.setItem('refeicaoAtual', JSON.stringify(refeicaoAtual));
            atualizarRefeicaoAtual();
        }

        // Calcular resumo nutricional
        function calcularResumoNutricional(refeicaoAtual) {
            const resumo = refeicaoAtual.reduce((total, item) => {
                const multiplier = item.quantidade / 100;
                return {
                    calorias: total.calorias + (item.ingrediente.calories * multiplier),
                    proteina: total.proteina + (item.ingrediente.protein * multiplier),
                    carbs: total.carbs + (item.ingrediente.carbs * multiplier),
                    gordura: total.gordura + (item.ingrediente.fat * multiplier),
                    fibra: total.fibra + (item.ingrediente.fiber * multiplier)
                };
            }, { calorias: 0, proteina: 0, carbs: 0, gordura: 0, fibra: 0 });
            
            document.getElementById('resumo-nutricional').innerHTML = `
                <div>Calorias: <strong>${Math.round(resumo.calorias)}</strong></div>
                <div>Prote√≠na: <strong>${Math.round(resumo.proteina)}g</strong></div>
                <div>Carbs: <strong>${Math.round(resumo.carbs)}g</strong></div>
                <div>Gordura: <strong>${Math.round(resumo.gordura)}g</strong></div>
                <div>Fibra: <strong>${Math.round(resumo.fibra)}g</strong></div>
            `;
        }

        // Salvar refei√ß√£o
        function salvarRefeicao() {
            const refeicaoAtual = JSON.parse(localStorage.getItem('refeicaoAtual') || '[]');
            
            if (refeicaoAtual.length === 0) {
                alert('Adicione pelo menos um ingrediente √† refei√ß√£o!');
                return;
            }
            
            // Obter data e hor√°rio
            const dataRefeicao = document.getElementById('data-refeicao').value;
            const horarioRefeicao = document.getElementById('horario-refeicao').value;
            
            if (!dataRefeicao || !horarioRefeicao) {
                alert('Por favor, preencha a data e hor√°rio da refei√ß√£o!');
                return;
            }
            
            // Calcular nutrientes
            const nutrientes = refeicaoAtual.reduce((total, item) => {
                const multiplier = item.quantidade / 100;
                return {
                    calorias: total.calorias + (item.ingrediente.calories * multiplier),
                    proteina: total.proteina + (item.ingrediente.protein * multiplier),
                    carbs: total.carbs + (item.ingrediente.carbs * multiplier),
                    gordura: total.gordura + (item.ingrediente.fat * multiplier),
                    fibra: total.fibra + (item.ingrediente.fiber * multiplier)
                };
            }, { calorias: 0, proteina: 0, carbs: 0, gordura: 0, fibra: 0 });
            
            // Salvar no hist√≥rico
            const dadosNutricionais = JSON.parse(localStorage.getItem('dadosNutricionais') || '{}');
            if (!dadosNutricionais[dataRefeicao]) {
                dadosNutricionais[dataRefeicao] = [];
            }
            
            // Criar objeto da refei√ß√£o
            const novaRefeicao = {
                id: Date.now(),
                horario: horarioRefeicao,
                alimentos: refeicaoAtual.map(item => `${item.ingrediente.name} (${item.quantidade}g)`),
                ingredientes: refeicaoAtual, // Salvar dados completos
                ...nutrientes,
                data: dataRefeicao,
                timestamp: new Date().toISOString()
            };
            
            dadosNutricionais[dataRefeicao].push(novaRefeicao);
            localStorage.setItem('dadosNutricionais', JSON.stringify(dadosNutricionais));
            
            // Limpar refei√ß√£o atual
            localStorage.removeItem('refeicaoAtual');
            atualizarRefeicaoAtual();
            
            // Limpar campos de data e hor√°rio
            document.getElementById('data-refeicao').value = '';
            document.getElementById('horario-refeicao').value = '';
            
            // Mostrar notifica√ß√£o de sucesso
            mostrarNotificacao('‚úÖ Refei√ß√£o salva com sucesso!', 'success');
            
            // Atualizar dashboard se estiver na mesma aba
            if (window.opener && !window.opener.closed) {
                window.opener.location.reload();
            }
        }

        // Mostrar notifica√ß√£o
        function mostrarNotificacao(mensagem, tipo = 'info') {
            // Remover notifica√ß√£o anterior se existir
            const notificacaoAnterior = document.getElementById('notificacao');
            if (notificacaoAnterior) {
                notificacaoAnterior.remove();
            }
            
            // Criar nova notifica√ß√£o
            const notificacao = document.createElement('div');
            notificacao.id = 'notificacao';
            notificacao.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${
                tipo === 'success' ? 'bg-green-500 text-white' : 
                tipo === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notificacao.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">${tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span>${mensagem}</span>
                </div>
            `;
            
            document.body.appendChild(notificacao);
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                if (notificacao.parentNode) {
                    notificacao.remove();
                }
            }, 3000);
        }

        // Definir data e hor√°rio padr√£o
        function definirDataHorarioPadrao() {
            const hoje = new Date().toISOString().split('T')[0];
            const agora = new Date().toTimeString().slice(0, 5);
            
            document.getElementById('data-refeicao').value = hoje;
            document.getElementById('horario-refeicao').value = agora;
        }

        // Inicializar
        renderizarIngredientes();
        atualizarRefeicaoAtual();
        definirDataHorarioPadrao();
    </script>
</body>
</html>
